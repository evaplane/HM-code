<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script>
        //判断有没有session
        var xhr = new XMLHttpRequest();
        xhr.open('get','./api/checkLogin.php');
        xhr.send();
        xhr.onreadystatechange=function(){
          if(xhr.readyState==4 && xhr.status==200){
            var obj=JSON.parse(xhr.responseText);
            console.log(obj);
            console.log(obj.msg);
            if(obj.msg!='ok'){
              location='login.html';
            }
          }
        }
      
      </script>
      
  <meta charset="utf-8">
  <title>Posts &laquo; Admin</title>
  <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.css">
  <link rel="stylesheet" href="../assets/vendors/font-awesome/css/font-awesome.css">
  <link rel="stylesheet" href="../assets/vendors/nprogress/nprogress.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
  <script src="../assets/vendors/nprogress/nprogress.js"></script>
</head>
<body>
  <script>NProgress.start()</script>

  <div class="main">
    <nav class="navbar">
      <button class="btn btn-default navbar-btn fa fa-bars"></button>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="profile.html"><i class="fa fa-user"></i>个人中心</a></li>
        <li><a href="api/doLoginOut.php"><i class="fa fa-sign-out"></i>退出</a></li>
      </ul>
    </nav>
    <div class="container-fluid">
      <div class="page-title">
        <h1>所有文章</h1>
        <a href="post-add.html" class="btn btn-primary btn-xs">写文章</a>
      </div>
      <!-- 有错误信息时展示 -->
      <!-- <div class="alert alert-danger">
        <strong>错误！</strong>发生XXX错误
      </div> -->
      <div class="page-action">
        <!-- show when multiple checked -->
        <a class="btn btn-danger btn-sm" id='delBatch' href="javascript:deleteBatch();" style="display: none">批量删除</a>
        <form class="form-inline">
          <select name="" id='selCategory' class="form-control input-sm">
            <option>所有分类</option>
            <!-- <option value="">未分类</option> -->
          </select>
          <select name="" id='selStatus' class="form-control input-sm">

            <!-- 注意:如果option里面有value,就会获取value的值,如果没有value,就会获取option的内容,所以所有分类和所有状态没有value
                  草稿和已发布的value值应该是他们的英文名字
            -->
            <option>所有状态</option>
            <option value="drafted">草稿</option>
            <option value="published">已发布</option>
          </select>
          <button class="btn btn-default btn-sm" id='btnSelect'>筛选</button>
        </form>
        <ul class="pagination pagination-sm pull-right">
          <li><a href="#">上一页</a></li>
          <li><a href="#">1</a></li>
          <li><a href="#">2</a></li>
          <li><a href="#">3</a></li>
          <li><a href="#">下一页</a></li>
        </ul>
      </div>
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th class="text-center" width="40"><input type="checkbox"></th>
            <th>标题</th>
            <th>作者</th>
            <th>分类</th>
            <th class="text-center">发表时间</th>
            <th class="text-center">状态</th>
            <th class="text-center" width="100">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-center"><input type="checkbox"></td>
            <td>随便一个名称</td>
            <td>小小</td>
            <td>潮科技</td>
            <td class="text-center">2016/10/07</td>
            <td class="text-center">已发布</td>
            <td class="text-center">
              <a href="javascript:;" class="btn btn-default btn-xs editBtn">编辑</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
          <tr>
            <td class="text-center"><input type="checkbox"></td>
            <td>随便一个名称</td>
            <td>小小</td>
            <td>潮科技</td>
            <td class="text-center">2016/10/07</td>
            <td class="text-center">已发布</td>
            <td class="text-center">
              <a href="javascript:;" class="btn btn-default btn-xs editBtn">编辑</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
          <tr>
            <td class="text-center"><input type="checkbox"></td>
            <td>随便一个名称</td>
            <td>小小</td>
            <td>潮科技</td>
            <td class="text-center">2016/10/07</td>
            <td class="text-center">已发布</td>
            <td class="text-center">
              <a href="javascript:;" class="btn btn-default btn-xs editBtn">编辑</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="aside">
    <div class="profile">
      <img class="avatar" src="../uploads/avatar.jpg">
      <h3 class="name">布头儿</h3>
    </div>
    <ul class="nav">
      <li>
        <a href="index.html"><i class="fa fa-dashboard"></i>仪表盘</a>
      </li>
      <li class="active">
        <a href="#menu-posts" data-toggle="collapse">
          <i class="fa fa-thumb-tack"></i>文章<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-posts" class="collapse in">
          <li class="active"><a href="posts.html">所有文章</a></li>
          <li><a href="post-add.html">写文章</a></li>
          <li><a href="categories.html">分类目录</a></li>
        </ul>
      </li>
      <li>
        <a href="comments.html"><i class="fa fa-comments"></i>评论</a>
      </li>
      <li>
        <a href="users.html"><i class="fa fa-users"></i>用户</a>
      </li>
      <li>
        <a href="#menu-settings" class="collapsed" data-toggle="collapse">
          <i class="fa fa-cogs"></i>设置<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-settings" class="collapse">
          <li><a href="nav-menus.html">导航菜单</a></li>
          <li><a href="slides.html">图片轮播</a></li>
          <li><a href="settings.html">网站设置</a></li>
        </ul>
      </li>
    </ul>
  </div>

  <script src="../assets/vendors/jquery/jquery.js"></script>
  <script src="../assets/vendors/bootstrap/js/bootstrap.js"></script>
  <!-- 1.导入插件 -->
  <script src='../assets/vendors/twbs-pagination/jquery.twbsPagination.min.js'></script>
  <script>NProgress.done()</script>
</body>
</html>

<script src='../assets/vendors/jquery/template-web.js'></script>

<script type='text/html' id='tplTr'>
  {{ each list value }}
  <tr>
      <td class="text-center"><input type="checkbox" value='{{ value.id }}'></td>
      <td>{{ value.title }}</td>
      <td>{{ value.nickname }}</td>
      <td>{{ value.name }}</td>
      <td class="text-center">{{ value.created }}</td>

    {{ if value.status=='published' }}
      <td class="text-center">已发布</td>
    {{ else }}
      <td class="text-center">草稿</td>
    {{ /if }}
      <td class="text-center">
        <a href="javascript:postEdit({{ value }})" class="btn btn-default btn-xs editBtn"  ">编辑</a>
        <a href="javascript:deleteTr({{ value.id }},);" class="btn btn-danger btn-xs">删除</a>
      </td>
    </tr>
    {{ /each }}

</script>

<script>
 
  var globalPage,totalPages;
  function loadData(page){
    globalPage=page;
    //每次加载页面的时候,去掉批量删除,thead的checkbox也取消
    $('#delBatch').fadeOut();
    $('thead :checkbox').prop('checked',false);

    $.get({
    url:"api/getPosts.php",
    data:{
      pageIndex:page,
      pageSize:10,
      // 正常加载的时候,这两个值就是所有状态和所有分类,在sql语句中不查找,所以找到的就是所有的数据,只有点击了筛选才会查找
      category:$('#selCategory').val(),
      status:$('#selStatus').val()
      },
    dataType:'json',
    success:function(obj){
      console.log(obj);
      totalPages=obj.totalPages;

      var html = template('tplTr',{list:obj.data});
      $('tbody').html(html);


      //插件的特点:只可以加载第一次调用时的数据,后面的加载不了了,所以要先销毁原来插件的调用
      //相当于每次点击都是重新加载这个方法,所以每次加载的时候都有一个默认开始的高亮,不能写第一页,要写当前页,也就是page
      $('.pagination').twbsPagination('destroy');

      //2.在页面显示成功后使用页码插件
      $('.pagination').twbsPagination({
        //2.1 总页数
        totalPages:obj.totalPages,
        //2.2 显示的页数
        visiblePages:7,
        //2.3 默认开始的页数,高亮
        startPage:page,
        //2.4 给first设置文本内容
        first:'首页',
        //2.5 给last设置文本内容
        last:'尾页',
        //2.6 给prev设置文本内容
        prev:'上一页',
        //2.7 给next设置文本内容
        next:'下一页',
        //2.8 给每一个li标签设置点击事件
        //event:事件对象
        //page:被点击的页码数
        onPageClick:function(event,page){
          //把被点击的页码数传入loadData(page),被点击哪一个pageIndex就是哪一页,就去数据库找这页的数据,显示在页面上
          loadData(page);
        },

        //2.9 最开始页码加载的时候不调用li点击事件
        initiateStartPageClick:false
      }) 
    }
  })
  }


//默认显示第一页
  loadData(1);

  //获取分类
  $.get({
    url:'api/getCategory.php',
    dataType:'json',
    success:function(obj){
      // console.log(obj);
      //把分类添加到页面上
      for(var i =0;i<obj.length;i++){
        // console.log(obj[i]);
        // 注意:不是特别复杂的结构添加到页面上不用模板
        $('<option>'+obj[i].name+'</option>').appendTo($('#selCategory'));
      }
    }
  })


  //点击筛选,注册事件

  $('#btnSelect').on('click',function(e){
      e.preventDefault();

      //调用loadData(1),点击筛选,默认显示帅选好的第一页
      loadData(1);
  })




  //点击全选,下面的全部选择,点击tbody里面的checkbox,如果全选中,thead里面的checkbox也会选中
  $('thead :checkbox').on('click',function(){
    $('tbody :checkbox').prop('checked',this.checked);

    if(this.checked){
      $('#delBatch').fadeIn();
    }else{
      $('#delBatch').fadeOut();
    }
  })


  $('tbody').on('click',':checkbox',function(){
    var checkNum = $('tbody :checked').length;
    var checkAllNum = $('tbody :checkbox').length;

    $('thead :checkbox').prop('checked',checkNum==checkAllNum);

    if(checkNum>=1){
      $('#delBatch').fadeIn();
    }else{
      $('#delBatch').fadeOut();
    }
  })


  //点击删除按钮,执行下面的函数,发送请求给deletePost.php,把id传过去
  function deleteTr(id){
      $.get({
        url:'api/deletePost.php',
        data:{ids:id},
        dataType:'json',
        success:function(obj){
          //如果是最后一页,而且只剩最后一个数据,就刷新上一页
          if(obj.msg=='ok'){
            //只有最后一页可能只有一行,其他的页面就算删到只剩一行,后面的也会补上,所以这里不用globalPage==totalPages
            if($('tbody :checkbox').length==1){
              loadData(globalPage-1);
            }else{
              loadData(globalPage);
            }

          }else{
            alert('修改失败!');
          }
           
        }
      })
  }

  //批量删除
  function deleteBatch(){

      //获取tbody里面被选中的checkbox,遍历,获取value值,value值是他们的id,在模板里赋值的
      var str = "";
      $('tbody :checked').each(function(index,ele){
        // console.log(index);
        // console.log(ele.value);
          //拿到每个value然后拼接
          str+=ele.value+",";
      })
     

      //去除str最后的逗号
      str = str.substr(0,str.length-1);
      // console.log(str);

      //发送请求
      $.get({
        url:'api/deletePost.php',
        dataType:'json',
        data:{ids:str},
        success:function(obj){
          // console.log(obj);
          if(obj.msg=='ok'){
            //如果是最后一页而且是删除全部就刷新上一页
            if(globalPage==totalPages && $('thead :checked').length>0){
                loadData(globalPage-1);
            }else{
            //刷新当前页面
              loadData(globalPage);

            }

          }else{
            alert('修改失败!');
          }
        } 
      })

  }


  //点击谁的编辑,就把哪个的id存到sessionStorage中
  // $('tbody').on('click','.editBtn',function(e){
  //     var post = $(this).attr('post');
      
  //     var json = JSON.stringify(post);
  //     sessionStorage.setItem('post',json);
  //     // location='post-edit.html';
  // })

  function postEdit(obj){
    var json = JSON.stringify(obj);
    sessionStorage.setItem('post',json);

    location="post-edit.html";
  }

</script>
